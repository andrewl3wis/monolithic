# Define a map to calculate the bypass condition
map $msec $bypass_cache {
    default 0;                                    # Default is no bypass
    "~^[0-9]+(03|33|63|93)[0-9]{3}$" 1;          # Matches milliseconds that align to ~30-minute intervals
}

# Cache InRelease files for 30 minutes
location ~* (InRelease)$ {
    proxy_cache inrelease_cache;
    proxy_cache_valid 200 30m;
    proxy_ignore_headers Cache-Control Expires;
    proxy_cache_min_uses 1;
    proxy_cache_bypass $bypass_cache;            # Dynamically bypass cache
    proxy_no_cache $bypass_cache;                # Prevent caching during bypass
    proxy_cache_key $scheme$host$request_uri;
    add_header X-Cache-Status $upstream_cache_status;
    proxy_pass http://$host$request_uri;
}
